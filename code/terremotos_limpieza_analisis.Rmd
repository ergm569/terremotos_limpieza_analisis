---
title: 'Tipología y ciclo de vida de los datos: PRA2'
author: "Autorse: Erick Franz García Miranda y Rafael Eduardo Garcia Agramonte"
date: "Abril 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header:
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```


******
# Descripción del dataset
******

El dataset corresponde al generado en la PRA1 utilizando tecnicas de webscraping con Python al sitio web: https://www.volcanodiscovery.com/es/earthquakes/ que muestra información de eventos sismicos al rededor del mundo.

El dataset contiene información de terremotos de 15 paises de centro y sur america como son: Argentina, Bolivia, Brasil, Chile, Colombia, Costa Rica, Ecuador, Guatemala, México, Panamá, Paraguay, Perú, Puerto Rico, República Dominicana, Venezuela); en el perido de 01 de enero del 2010 hasta el 05 de abril del 2021. El dataset tiene formato .csv y tiene **12507 registros.**

Cada registro representa un evento sismico y contiene los siguientes campos:

* **Fecha y Hora:** Fecha en formato día-mes-año y hora específicos en que ocurrió el sismo.
* **Magnitud:** Indica la de magnitud del sismo en escala sismológica de richter.
* **Profundidad:** Distancia de donde se origina el fenómeno con respecto al centro de la tierra.
* **Ubicación:** Lugar en donde se produjo el sismo.
* **Año:** Año en que ocurrió el sismo.
* **País:** Nombre de la nación afectada por el sismo.

La importancia del dataset se encuentra en lo impredecible y potencialmente debastador que es un evento sismico. Un registro completo de estos eventos hace que el potencial de analisis del dataset sea elevado.

En este proyecto se utilizará el dataset para responder la pregunta general de **"¿Existe algún patrón o patrones en la actividad sismica de america latina (centro america y sur america)?"**  
Este pregunta la podemos dividir en 3 preguntas especificas:

* **¿Cuál es el país con actividad sismica más intensa?**
* **¿Qué variables son más relevantes o significativas en la ocurrencia de un sismo?**
* **¿Cual es la relación entre las variables de un sismo?**


******
# Integración y selección
******

Primero, importaremos el dataset.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Importamos el data set
data_terremotos<-read.csv("../data/terremotos_centro_sur_america.csv",header=T,sep=",")
head(data_terremotos)
# Cantidad de registros
dim(data_terremotos)[1]
```

***Fecha y hora:***

Convertiremos la fecha y hora del tipo de cadena de texto al de fecha y hora:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Cargamos la librería Lubridate 
library(lubridate)

# Convertimos a tipo fecha y hora
data_terremotos$Fecha.y.Hora <- dmy_hms(substr(data_terremotos$Fecha.y.Hora, start = 1 , stop = 20) )
head(data_terremotos$Fecha.y.Hora)
```

Creamos algunas columnas adicionales que serán útiles al momento de realizar los analisis.


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Número de mes
data_terremotos$Mes <- month(data_terremotos$Fecha.y.Hora)
# Hora
data_terremotos$Hora <- hour(data_terremotos$Fecha.y.Hora)
# Día de la semana
data_terremotos$Dia.Semana <- wday(data_terremotos$Fecha.y.Hora, label = TRUE, abbr = FALSE)
```

***Magnitud y Profundidad***

Tranformaremos los campos de Magnitud y Profundidad de tipo cadena de texto a valores numéricos:


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Convertimos a tipo numérico la Magnitud
data_terremotos$Magnitud <- as.numeric(data_terremotos$Magnitud)

# Quitamos los caracteres y convertimos a tipo numérico la Profundidad
data_terremotos$Profundidad <- gsub('Â', '', data_terremotos$Profundidad)
data_terremotos$Profundidad <- gsub('km', '', data_terremotos$Profundidad)
data_terremotos$Profundidad <- gsub('.{1}$', '', data_terremotos$Profundidad)
data_terremotos$Profundidad <- as.numeric(data_terremotos$Profundidad)
```



******
# Limpieza
******

##  Elementos vacios

Vamos a revisar los valores vacios del dataset:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Estadísticas de valores vacíos
colSums(is.na(data_terremotos))
colSums(data_terremotos[c("Magnitud","Profundidad","Ubicacion")]=="")
```

Podemos observar que no existen valores nulos, por lo que no será necesario realizar un tratamiento.

##  Valores extremos

Primero, realizaremos un analisis de los valores extremos para la Profundidad y la Magnitud de manera individual a través de boxplots.

Analizaremos la Profundidad.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calcular el boxplot de la Profundidad
Profundidad.bp <- boxplot(data_terremotos$Profundidad)
# Calculamos el rango de los outliers
range(Profundidad.bp$out)
# Calcular la cantidad de los outliers
length(Profundidad.bp$out)
```

Podemos observar que existen 159 valores outliers de la variable Profundidad que **tienen valores entre 288 a 750 km.**

Ahora, analizaremos la Magnitud.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calcular el boxplot de la Magnitud
Magnitud.bp <- boxplot(data_terremotos$Magnitud)
# Calculamos el rango de los outliers
range(Magnitud.bp$out)
# Calcular la cantidad de los outliers
length(Magnitud.bp$out)
```

Observamos que o existen outliers de la variable Magnitud.

También, analizaremos las variables Profundidad y Magnitud utilizando la **distancia de Mahalanobis** para encontrar 100 outliers.

```{r echo=TRUE, message=FALSE, warning=FALSE}
#ap <- data.frame(Altura.cm=c(164, 167, 168, 169, 169, 170, 170, 170, 171,172, 172, 173, 173, 175, 176, 178), Peso.kg=c( 54, 57, 58, 60, 61, 60,61, 62, 62, 64, 62, 62, 64, 56, 66, 70))


#Criterio +/-2SD
ap <- data_terremotos[,c("Profundidad","Magnitud")]
Profundidad.outlier <- abs(scale(data_terremotos$Profundidad)) > 2
Magnitud.outlier <- abs(scale(data_terremotos$Magnitud)) > 2
pch <- (Profundidad.outlier | Magnitud.outlier) * 12
pch <- pch + 4
col <- (Profundidad.outlier | Magnitud.outlier) * 12
col <- pch + 4
  
par(mfrow=c(1,2))
plot(ap, pch=pch,col=col,main="Criterio +-2 Desv.Stand.")

#Criterio distancia Mahalanobis (los dos outliers más extremos)
n.outliers <- 100
m.dist.order <- order(mahalanobis(ap, colMeans(ap), cov(ap)), decreasing=TRUE)
is.outlier <- rep(FALSE, nrow(ap))
is.outlier[m.dist.order[1:n.outliers]] <- TRUE
pch <- is.outlier * 12
pch <- pch + 4
col <- is.outlier * 12
col <- pch + 4
plot(ap, pch=pch,col=col,main="Criterio distancia mahalanobis")
```

Podemos observar que los outliers, según el criterio de mahalanobis, son puntos con altos valores de Profundidad; al igual que con el criterio de -+2 desviaciones estandar. Esto se debe a la manera en que están distribuidos los datos, donde se observa que la Profundidad es la variable con mayor dispersión. 

Hallaremos el rango de los 100 puntos extremos calculados:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Rango de los outliers
range(ap[is.outlier,]$Profundidad)
```

Finalmente, concluimos que existen 159 outliers con **Profundidades mayores a 288 km (criterio +-2Desv.).** De los cuales los 100 outliers más extremos tienen **Profundidades mayores a 523 km (Criterio mahalanobis).**

Al ser datos reales de sismos, no haremos ningún tratamiento adicional a estos valores.


******
# Analisis de datos
******

##  Planificación

Con el objetivo de responder las 3 preguntas especificas planteadas en el *apartado 1. Descripción*, se realizarán tres analisis estadisticos:

* **Contraste de hipotesis**, para determinar qué paises se dan los sismos de mayor intensidad/profundidad y con qué significancia.
* Un modelo de **regresion logísica**, donde se modelará la probabilidad de que ocurra un sismo de acuerdo a las varibles del dataset. Nos ayudará a determinar que variables son significativas para la ocurrencia de un sismo.
* Analisis de **correlacion**, para determinar si existe una correlación entre: 1) la intensidad y la profundidad y 2) la longitud/latitud y la intensidad y 3) la longitud/latitud y la profundidad.

Por lo tanto, para el contraste de hipotesis los grupos a comparar serán los paises. Y para la regresión y la correlación el analisis se realizará al conjunto de datos en su totalidad.


##  Normalidad y Homocedasticidad

Antes de realizar las pruebas estadisticas, vamos a comprobar la Normalidad y Homocedasticidad de los datos.

Primero, comprobaremos la ***normalidad*** de los datos. Para ello utilizaremos el test de  **Kolmogorov-Smirnov** para las variables **Magnitud y Profunidad.** No optamos usar el test Shapiro-wilk porque el tamaño de los registros superan los 5000.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Kolmogorov-Smirnov aplicado a la Magnitud
ks.test(data_terremotos$Magnitud, pnorm, mean(data_terremotos$Magnitud), sd(data_terremotos$Magnitud))
```

El p-value es menor a 0.05, por lo que se rechaza la hipotesis nula. Se acepta la hipotesis alternativa, que la Magnitud no sigue una distribución Normal.


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Kolmogorov-Smirnov aplicado a la Profundidad
ks.test(data_terremotos$Profundidad, pnorm, mean(data_terremotos$Profundidad), sd(data_terremotos$Profundidad))
```

El p-value es menor a 0.05, por lo que se rechaza la hipotesis nula. Se acepta la hipotesis alternativa, que la Profundidad no sigue una distribución Normal.

Por lo tanto, concluimos que ***la Magnitud y la Profundidad no siguen una distribución normal.***


Ahora, comprobaremos la ***homocedasticidad*** (homogeneidad de la varianza). Para ello utilizaremos el test **Fligner-Killeen,** utilizado para datos que no cumplen con la condición de normalidad, para las variables **Magnitud y Profunidad** según los grupos de **Paises.**

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Fligner-Killeen aplicado a la Intensidad para los grupos de paises.
fligner.test(Magnitud ~ Pais, data = data_terremotos)
```

El p-value es menor a 0.05, por lo que se rechaza la hipotesis nula. Se acepta la hipotesis alternativa, que **la Magnitud presenta varianzas estadisticamente diferentes para los distintos grupos de Paises.**

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Fligner-Killeen aplicado a la Profundidad para los grupos de paises.
fligner.test(Profundidad ~ Pais, data = data_terremotos)
```

El p-value es menor a 0.05, por lo que se rechaza la hipotesis nula. Se acepta la hipotesis alternativa, que **la Profundidad presenta varianzas estadisticamente diferentes para los distintos grupos de Paises.**

Por lo tanto, concluimos que ***la Magnitud y la Profundidad presentan varianzas diferentes para los Paises.***


##  Pruebas estadísticas

En este apartado realizaremos los 3 análisis descritos en la sección *4.1 Planificación.*

### Contraste de Hipotesis

Realizaremos una analisis de contraste de hipotesis para saber qué pais tiene una magnitud y profundidad estadisticamente mayor a los demás.

Mostramos las medias de Magnitud y Profundidad de los paises:

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(plyr)
# Contruimos una tabla con la media y varianza de la Magnitud de los Paises
# Calculamos la media
t_mean <- aggregate(data_terremotos$Magnitud, list(data_terremotos$Pais) , mean)
colnames(t_mean) <- c("Pais","Media")
# Calculamos la varianza
t_var <- aggregate(data_terremotos$Magnitud, list(data_terremotos$Pais) , var)
colnames(t_var) <- c("Pais","Varianza")
# Calculamos la cantidad de sismos
t_count <- count(data_terremotos,"Pais")
colnames(t_count) <- c("Pais","Cantidad")
# Contruimos la tabla y la ordenamos
table_pais <- merge(t_mean,t_var, by = "Pais")
table_pais <- merge(table_pais,t_count, by = "Pais")
table_pais[order(table_pais$Media,decreasing = TRUE),]
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Contruimos una tabla con la media y varianza de la Profundidad de los Paises
# Calculamos la media
t_mean <- aggregate(data_terremotos$Profundidad, list(data_terremotos$Pais) , mean)
colnames(t_mean) <- c("Pais","Media")
# Calculamos la varianza
t_var <- aggregate(data_terremotos$Profundidad, list(data_terremotos$Pais) , var)
colnames(t_var) <- c("Pais","Varianza")
# Calculamos la cantidad de sismos
t_count <- count(data_terremotos,"Pais")
colnames(t_count) <- c("Pais","Cantidad")
# Contruimos la tabla y la ordenamos
table_pais <- merge(t_mean,t_var, by = "Pais")
table_pais <- merge(table_pais,t_count, by = "Pais")
table_pais[order(table_pais$Media,decreasing = TRUE),]
```

En el caso de Paraguay, decidimos no considerarla por la baja cantidad de sismos (30) y alta varianza.
Podemos observar que los 3 paises con mayor magnitud son: Brazil, Chile y Mexico. Pero todos los paises tienen valores aparentemente parecidos.
También, observamos que los 3 paises con mayor profundidad de sismo son: Argentina, Bolivia y Brazil.

A continuación, realizaremos el test Kruskal-Wallis (test no paramétrico) para comprobar que las medias de la Magnitud y la Profundidad sean iguales en todos los paises. Comenzaremos con la Magnitud:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Kruskal para la Magnitud según los Paises. Sin considerar a Paraguay
kruskal.test(Magnitud ~ Pais, data = data_terremotos[data_terremotos$Pais!='paraguay',])
```

Dado que el p-value es menor a la 0.05 por lo que rechazamos la hipotesis nula y aceptamos la hipotesis alternativa, que es que la Magnitud muestra diferencias significativas para los diferentes paises.
Ahora realizaremos el test a la Profundidad: 

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Test Kruskal para la Progundidad los Paises. Sin considerar a Paraguay
kruskal.test(Profundidad ~ Pais, data = data_terremotos[data_terremotos$Pais!='paraguay',])
```

Dado que el p-value es menor a la 0.05 por lo que rechazamos la hipotesis nula y aceptamos la hipotesis alternativa, que es que la Profundida muestra diferencias significativas para los diferentes paises.

Por lo tanto, concluimos que **los paises no tienen la misma Magnitud y la Profundida estadisticamente.** Una vez comprobada las diferencias de las medidas, comprobaremos si los paises en los primeros lugares son estadisticamente superiores a los demás.

***Primero, analizaremos la Magnitud.*** Estamos frente a un constraste de dos muestras independientes con varianzas desconocidas diferentes; además por el teorema de límite central (muestras mayores a 30) se puede asumir normalidad. Por lo tanto podemos utilizar el t-test para realizar este contraste de hipotesis.

Validaremos si la Magnitud de Brazil (1°) es superior a Chile (2°). Las hipotesis son:
H0: La Magnitud media de Brazil y Chile son iguales.
H1: La Magnitud media de Brazil es mayor a la de Chile.

Aplicando el t-test:

```{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(data_terremotos$Magnitud[data_terremotos$Pais=='brazil'],data_terremotos$Magnitud[data_terremotos$Pais=='chile'],alternative="greater", var.equal=FALSE)
```

El p-value es menor al una significancia de 0.01. Por lo que se rechaza la hipotesis nula y se acepta la alternativa. Es decir aceptamos que Brazil tiene una Magnitud media mayor que Chile, con un nivel de confianza de 99%.

Validaremos si la Magnitud de Brazil (1°) es superior a México (3°). Las hipotesis son:
H0: La Magnitud media de Brazil y México son iguales.
H1: La Magnitud media de Brazil es mayor a la de México

Aplicando el t-test:

```{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(data_terremotos$Magnitud[data_terremotos$Pais=='brazil'],data_terremotos$Magnitud[data_terremotos$Pais=='mexico'],alternative="greater", var.equal=FALSE)
```

El p-value es menor al una significancia de 0.01. Por lo que se rechaza la hipotesis nula y se acepta la alternativa. Es decir aceptamos que Brazil tiene una Magnitud media mayor que México, con un nivel de confianza de 99%.

**Con esto validamos que Brazil es el pais con mayor magnitud sismica de latino america**


***Segundo, analizaremos la Profundidad*** Estamos frente a un constraste de dos muestras independientes con varianzas desconocidas diferentes; además por el teorema de límite central (muestras mayores a 30) se puede asumir normalidad. Por lo tanto podemos utilizar el t-test para realizar este contraste de hipotesis.

Validaremos si la Profundidad de Argentina (1°) es superior a Bolivia (2°). Las hipotesis son:
H0: La Profundidad media de Argentina y Bolivia son iguales.
H1: La Profundidad media de Argentina es mayor a la de Bolivia

Aplicando el t-test:

```{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(data_terremotos$Profundidad[data_terremotos$Pais=='argentina'],data_terremotos$Profundidad[data_terremotos$Pais=='bolivia'],alternative="greater", var.equal=FALSE)
```

El p-value es menor al una significancia de 0.01. Por lo que se rechaza la hipotesis nula y se acepta la alternativa. Es decir aceptamos que Argentina tiene una Profundidad media mayor que Bolivia, con un nivel de confianza de 99%.

Validaremos si la Profundidad de Argentina (1°) es superior a Brazil (3°). Las hipotesis son:
H0: La Magnitud media de Argentina y Brazil son iguales.
H1: La Magnitud media de Argentina es mayor a la de Brazil

Aplicando el t-test:

```{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(data_terremotos$Profundidad[data_terremotos$Pais=='argentina'],data_terremotos$Profundidad[data_terremotos$Pais=='brazil'],alternative="greater", var.equal=FALSE)
```

El p-value es menor al una significancia de 0.01. Por lo que se rechaza la hipotesis nula y se acepta la alternativa. Es decir aceptamos que Argentina tiene una Profundidad media mayor que Brazil, con un nivel de confianza de 99%.

**Con esto validamos que Argentina es el pais con mayor profundidad sismica de latino america**

### Regresión Logística

### Correlación

******
# Gráficos y tablas de resultados
******


******
# Resolución del problema
******


******
# Código
******



```{r echo=TRUE, message=FALSE, warning=FALSE}

```


Posibles puntos a adicionar:
Utilizar los años para prueba de hipotesis.
Analisis de extremos para las coordenadas.
Revisar normalidad y homocedasticidad para coordenas.

